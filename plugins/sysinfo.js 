const os = require('os');
const si = require('systeminformation');

function formatTime(seconds) {
  const d = Math.floor(seconds / 86400);
  const h = Math.floor((seconds % 86400) / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  
  const parts = [];
  if (d > 0) parts.push(d + 'd');
  if (h > 0) parts.push(h + 'h');
  if (m > 0) parts.push(m + 'm');
  parts.push(s + 's');
  
  return parts.join(' ');
}

module.exports = {
  command: ['sysinfo', 'system'],
  category: 'utility',
  description: 'Show system information',

  async execute(sock, m, { reply, isOwner }) {
    if (!isOwner) {
      return reply('This command is only for owner');
    }

    await reply('Collecting system info...');

    try {
      const cpu = await si.cpu();
      const mem = await si.mem();
      const disks = await si.fsSize();

      const cpuUsage = os.loadavg()[0].toFixed(2);
      
      const totalMem = (mem.total / 1024 / 1024 / 1024).toFixed(2);
      const usedMem = (mem.used / 1024 / 1024 / 1024).toFixed(2);
      const memPercent = ((mem.used / mem.total) * 100).toFixed(2);

      let totalDisk = 0;
      let usedDisk = 0;
      for (let i = 0; i < disks.length; i++) {
        totalDisk += disks[i].size;
        usedDisk += disks[i].used;
      }
      totalDisk = (totalDisk / 1024 / 1024 / 1024).toFixed(2);
      usedDisk = (usedDisk / 1024 / 1024 / 1024).toFixed(2);
      const diskPercent = ((usedDisk / totalDisk) * 100).toFixed(2);

      const botUptime = formatTime(process.uptime());
      const sysUptime = formatTime(os.uptime());

      const text = 'SYSTEM INFORMATION\n\n' +
        'CPU\n' +
        'Model: ' + cpu.manufacturer + ' ' + cpu.brand + '\n' +
        'Cores: ' + cpu.cores + '\n' +
        'Speed: ' + cpu.speed + ' GHz\n' +
        'Load: ' + cpuUsage + '%\n\n' +
        'MEMORY\n' +
        'Total: ' + totalMem + ' GB\n' +
        'Used: ' + usedMem + ' GB\n' +
        'Usage: ' + memPercent + '%\n\n' +
        'STORAGE\n' +
        'Total: ' + totalDisk + ' GB\n' +
        'Used: ' + usedDisk + ' GB\n' +
        'Usage: ' + diskPercent + '%\n\n' +
        'SYSTEM\n' +
        'OS: ' + os.type() + ' ' + os.release() + '\n' +
        'Arch: ' + os.arch() + '\n' +
        'Platform: ' + os.platform() + '\n' +
        'Node: ' + process.version + '\n\n' +
        'UPTIME\n' +
        'Bot: ' + botUptime + '\n' +
        'System: ' + sysUptime;

      await reply(text);

    } catch (error) {
      console.error('Sysinfo error:', error);
      await reply('Failed to get system info: ' + error.message);
    }
  }
  }